# Project Understanding Summary — Go2Asia v2

**Дата создания:** 2025-12-11  
**Версия:** 1.0  
**Статус:** Утверждено

---

## 1. Цель экосистемы

Go2Asia — цифровая экосистема путешествий, жизни и бизнеса в Юго-Восточной Азии, объединяющая путешественников, экспатов, локальный бизнес и PRO-кураторов в единое пространство данных, экономики и взаимодействий.

### Ключевые принципы:
- **Интеграция сервисов** — модули работают как единое целое
- **Единая экономика вознаграждений** — двухконтурная токеномика (Points + G2A + NFT)
- **Сообщество, движимое контентом** — UGC и экспертный контент от PRO
- **Геймификация** — квесты, достижения, реферальная система
- **Партнёрская сеть** — Russian Friendly для локального бизнеса

---

## 2. Ключевые пользовательские сценарии

### Сценарий 1: Путешественник открывает Guru Asia
1. Пользователь открывает PWA, разрешает геолокацию
2. Guru показывает карту и список объектов "рядом": места (Atlas), события (Pulse), жильё (Rielt), партнёры (RF), активные PRO (Space)
3. Клик на место → переход в Atlas для деталей
4. Клик на событие → переход в Pulse для регистрации
5. Получение ваучера RF → использование в партнёрском заведении

### Сценарий 2: PRO-куратор создаёт квест
1. PRO входит в Quest Asia
2. Создаёт квест "Гастро-тур по Бали" с точками из RF-партнёров
3. Участники проходят квест, посещают места, получают ваучеры
4. Завершение → начисление Points и NFT участникам
5. PRO получает G2A токены за успешное вовлечение партнёров

### Сценарий 3: Пользователь приглашает друзей
1. Spacer получает реферальную ссылку
2. Делится ссылкой с друзьями
3. Друзья регистрируются → начисление Points спонсору
4. Друг становится VIP → разблокировка второго уровня рефералов
5. Spacer получает бонусы за активность рефералов и субрефералов

### Сценарий 4: Бизнес-партнёр подключается к RF
1. PRO-куратор находит потенциального партнёра
2. Партнёр регистрируется через RF Asia
3. Создаёт профиль, выпускает ваучеры
4. Пользователи получают ваучеры через Guru/Quest
5. Использование ваучеров → начисление G2A партнёру и PRO-куратору

---

## 3. Карта сервисов

### Core Services (Базовые)
| Сервис | Назначение | Технологии |
|--------|-----------|------------|
| **User/Auth Service** | Управление пользователями, SSO (Clerk), роли | Cloudflare Worker, Clerk, JWT (jose) |
| **Guru Service** | Гео-агрегатор "рядом со мной" | Cloudflare Worker, агрегация данных |
| **API Gateway** | Единая точка входа, маршрутизация, rate limiting | Cloudflare Worker/Pages Functions |

### Content Services (Контентные)
| Сервис | Назначение | Зависимости |
|--------|-----------|-------------|
| **Atlas Service** | Wiki-энциклопедия локаций (страны, города, места) — доменный сервис, владеет данными | База для всех геоданных |
| **Pulse Service** | Календарь событий и афиша — доменный сервис, владеет данными | Использует Atlas для мест проведения |
| **Media/Blog Service** | Статьи, новости, медиа-контент — доменный сервис, владеет данными | Получает UGC из Space |
| **Content API Service** | **Агрегатор/фасад** — объединяет данные из Atlas/Pulse/Media в унифицированные фиды и карточки для фронтенда | Зависит от Atlas/Pulse/Media, не хранит данные |

### Social Services (Социальные)
| Сервис | Назначение | Интеграции |
|--------|-----------|------------|
| **Content Service** | Хранение постов, комментариев Space — доменный сервис для социального контента | Интеграция с Feed Service |
| **Feed Service** | Формирование персональных лент — агрегирует данные Content Service | Агрегирует данные Content Service |
| **Reactions Service** | Универсальная система реакций (лайки, отзывы, вопросы) | Заменяет комментарии и чаты |

### Commerce Services (Коммерческие)
| Сервис | Назначение | Особенности |
|--------|-----------|-------------|
| **RF Service** | Каталог партнёров Russian Friendly | Интеграция с Atlas, ваучерами |
| **Voucher Service** | Управление ваучерами и спецпредложениями | Используется RF и Quest |
| **Rielt Service** | Объявления жилья (аренда) | Геопривязка через Atlas |

### Gamification Services (Геймификация)
| Сервис | Назначение | Награды |
|--------|-----------|---------|
| **Quest Service** | Квесты, миссии, маршруты | Points, NFT, ваучеры |
| **Referral Service** | Реферальная программа | Points за приглашения |

### Tokenomics Services (Токеномика)
| Сервис | Назначение | Контур |
|--------|-----------|--------|
| **Token Service** | Агрегированный view по всем токенам и бизнес-правилам (Points, G2A, NFT). В Фазе 1 — только Points | Off-chain |
| **Points Service** | Частые микротранзакции баллов (выделяется в Фазе 3 для оптимизации нагрузки) | Off-chain |
| **NFT Service** | Управление Local NFT-бейджами (off-chain), интеграция с Blockchain Gateway для on-chain NFT | Off-chain → On-chain |
| **Blockchain Gateway** | Шлюз к блокчейну TON для on-chain операций | On-chain операции |

### Technical Services (Технические)
| Сервис | Назначение |
|--------|-----------|
| **Notification Service** | Push, email, Telegram уведомления (реализуется в Фазе 3-4) |
| **Logging/Analytics Service** | Централизованные логи, метрики, трассировка (базовая инфраструктура в Фазе 0, расширение в Фазе 4) |

---

## 4. Карта UI-модулей

### Структура Frontend (PWA Shell + Microfrontends)

```
go2asia-pwa-shell/ (App Shell)
├── app/
│   ├── (public)/          # Публичные страницы (SSR/SSG)
│   │   ├── atlas/         # Feature Capsule: Atlas
│   │   ├── pulse/         # Feature Capsule: Pulse
│   │   ├── blog/          # Feature Capsule: Blog
│   │   └── guru/          # Feature Capsule: Guru
│   └── (authenticated)/   # Защищённые модули
│       ├── connect/       # Feature Capsule: Connect
│       ├── space/         # Feature Capsule: Space
│       ├── quest/         # Feature Capsule: Quest
│       ├── rf/            # Feature Capsule: RF Partners
│       └── rielt/         # Feature Capsule: Rielt
└── features/              # Feature Capsules (изолированные модули)
    ├── atlas-ui/
    ├── pulse-ui/
    ├── blog-ui/
    └── ...
```

### Модули и их назначение:

| Модуль | Роут | Назначение | Backend Service |
|--------|------|-----------|----------------|
| **Guru Asia** | `/guru` | Гео-агрегатор "рядом со мной" | Guru Service |
| **Atlas Asia** | `/atlas` | Wiki-энциклопедия локаций | Atlas Service |
| **Pulse Asia** | `/pulse` | Календарь событий | Pulse Service |
| **Blog Asia** | `/blog` | Медиаплатформа | Media Service |
| **Space Asia** | `/space` | Социальная сеть | Content + Feed Service |
| **Quest Asia** | `/quest` | Квесты и миссии | Quest Service |
| **RF Asia** | `/rf` | Каталог партнёров | RF Service |
| **Rielt.Market** | `/rielt` | Поиск жилья | Rielt Service |
| **Connect Asia** | `/connect` | Кошелёк, рефералы, статусы | Token + Referral Service |

### Технологический стек Frontend:
- **Framework:** Next.js 15 (App Router)
- **Language:** TypeScript
- **Styling:** Tailwind CSS + shadcn/ui
- **State:** React Query + Zustand
- **Design System:** `@go2asia/ui` + `@go2asia/design-system`
- **API Client:** Автогенерируемый SDK из OpenAPI

---

## 5. Ключевые ограничения

### Технические ограничения:
1. **Cloudflare Workers Runtime** — только совместимые библиотеки (не Node.js streams)
2. **Единая JWT библиотека** — только `jose` (запрещены другие)
3. **Микросервисы не импортируют друг друга** — только HTTP/API Gateway
4. **OpenAPI-first** — все API изменения начинаются с OpenAPI спецификации
5. **Миграции в репозитории** — SQL-файлы коммитятся, не генерируются автоматически

### Архитектурные ограничения:
1. **Feature Capsules изолированы** — не могут импортировать друг друга
2. **Общий код только "без состояния"** — типы, SDK, UI, схемы, логгер
3. **Кастодиальные кошельки** — пользователи не управляют приватными ключами
4. **Off-chain по умолчанию** — on-chain только по запросу пользователя

### Бизнес-ограничения:
1. **Нет обещаний прибыли** — токены позиционируются как утилитарные
2. **VIP/PRO монетизация** — платные статусы, но контент бесплатный
3. **Реферальная глубина** — максимум 2 уровня (требуется VIP для второго)

---

## 6. Ключевые NFR (Non-Functional Requirements)

### Производительность:
- **P99 latency:** < 500ms для гео-запросов (Guru)
- **P95 latency:** < 200ms для API Gateway (GET), < 500ms (POST)
- **Time to Interactive:** < 3s на 4G
- **Largest Contentful Paint:** < 2.5s

### Доступность (Availability):
- **API Gateway:** 99.9%
- **Content Service:** 99.5%
- **Auth Service:** 99.95%
- **Token Service:** 99.9%

### Масштабируемость:
- **Горизонтальное масштабирование** всех микросервисов
- **Edge-кэширование** для публичного контента (TTL 600s)
- **Шардирование БД** при росте данных
- **Кластеризация поискового движка** (Meilisearch/Elastic)

### Безопасность:
- **mTLS** для межсервисного взаимодействия
- **JWT с коротким временем жизни** + refresh tokens
- **Rate limiting** на API Gateway
- **HSM** для приватных ключей блокчейна
- **KYC/AML** для крупных выводов токенов

### Наблюдаемость (Observability):
- **RequestId** для сквозной трассировки
- **Централизованное логирование** (Cloudflare Logs → ClickHouse)
- **Метрики** через Prometheus/Cloudflare Analytics
- **Алерты** на критичные метрики (error rate, latency, availability)

---

## 7. Уровни пользователей

### Spacer (Базовый пользователь)
- **Доступ:** Все публичные модули, создание контента
- **Вознаграждения:** Points за активность
- **Рефералы:** Базовые бонусы за приглашения
- **Ограничения:** Не может тратить Points на ваучеры/квесты

### VIP Spacer (Платный статус)
- **Стоимость:** 1000 ₽/месяц
- **Дополнительно:**
  - Расширенные реферальные бонусы (2 уровня)
  - Право тратить Points на ваучеры и квесты
  - Кэшбэк от трат рефералов (10% с реферала, 2% с субреферала)
- **Вознаграждения:** Points + косвенный доступ к G2A через рефералов

### PRO Spacer (Куратор)
- **Получение:** По приглашению команды или через программу развития
- **Дополнительно:**
  - Все возможности VIP
  - Создание квестов и событий
  - Привлечение RF-партнёров
  - Модерация контента
  - Экспертные статьи в Blog
- **Вознаграждения:** Points + G2A токены за партнёрскую активность

### Business Partner (RF Partner)
- **Доступ:** Личный кабинет RF, управление ваучерами, статистика
- **Вознаграждения:** G2A токены за использование ваучеров
- **Интеграция:** Профиль в Atlas, отображение в Guru

---

## 8. Токеномика в кратком виде

### Двухконтурная модель:

#### Off-chain контур:
- **Points** — внутренние баллы лояльности
  - Начисление за активность (посты, лайки, квесты)
  - Конвертация в Local NFT
  - Использование VIP/PRO для ваучеров и квестов
  
- **Local NFT** — оффчейн-бейджи достижений
  - Получение через конвертацию Points или достижения
  - Апгрейды и обмен внутри платформы
  - Подготовка к выводу on-chain

#### On-chain контур:
- **G2A Token** — утилитарный токен на TON
  - Выпуск для PRO за партнёрскую активность
  - Конвертация Points → G2A (с лимитами)
  - Вывод на внешние кошельки TON
  
- **On-chain NFT** — редкие бейджи в блокчейне
  - Выпуск особых достижений
  - Коллекционная ценность
  - Возможность торговли

### Цепочка преобразования ценности:
```
Активность → Points → Local NFT → On-chain NFT → G2A Token
```

### Ключевые правила:
- **Кастодиальные кошельки** — платформа хранит активы от имени пользователя
- **Нет обещаний прибыли** — токены как утилитарные инструменты
- **Прозрачность через блокчейн** — все on-chain операции видны
- **Раздельный учёт** — фиатные и токеновые операции разделены

---

## 9. Интеграции между модулями

### Content API Service как агрегатор/фасад:
- Объединяет данные из доменных сервисов: Atlas, Pulse, Media/Blog
- Предоставляет унифицированные фиды и карточки для фронтенда
- Не хранит данные, только агрегирует через HTTP-запросы к доменным сервисам
- Кэширует результаты для производительности

### Guru как агрегатор:
- Собирает данные из: Atlas, Pulse, Rielt, RF, Space, Blog
- Нормализует в единый формат EntityCard
- Ранжирует по расстоянию, времени, популярности
- Может использовать Content API Service как один из источников

### Atlas как база геоданных:
- Используется всеми модулями для привязки к локациям
- Pulse → место проведения события
- Rielt → город/район объявления
- Blog → привязка статей к местам

### Connect как центр экономики:
- Получает события от всех модулей
- Начисляет Points/NFT/G2A по правилам
- Отображает единый баланс пользователя

### Space ↔ Blog:
- Space — источник UGC для Blog
- Blog — витрина лучшего контента
- Двунаправленный поток контента

### RF ↔ Quest:
- Квесты используют RF-места как точки
- Ваучеры RF выдаются как награды в квестах
- PRO-кураторы связывают партнёров и квесты

---

## 10. Архитектурные решения

### Микрофронтенды (ADR-0001):
- **Причина:** Независимая разработка модулей
- **Решение:** PWA Shell + Feature Capsules
- **Технология:** Next.js 15 App Router, Module Federation

### Drizzle ORM (ADR-0002):
- **Причина:** Типобезопасность, edge-runtime совместимость
- **Решение:** Drizzle как основная ORM
- **Альтернативы:** Prisma (слишком тяжёлый для edge)

### Двухконтурная токеномика (ADR-0008):
- **Причина:** Безопасность, юридическая чистота
- **Решение:** Off-chain Token Service + Blockchain Gateway
- **Преимущества:** Скорость off-chain, прозрачность on-chain

---

## 11. Технологический стек

### Frontend:
- Next.js 15 (App Router)
- TypeScript
- Tailwind CSS + shadcn/ui
- React Query
- Zustand

### Backend:
- Cloudflare Workers/Pages Functions
- Node.js + TypeScript
- Drizzle ORM
- PostgreSQL (Neon)
- jose (JWT)

### Инфраструктура:
- **Frontend Hosting:** Netlify
- **Backend Hosting:** Cloudflare Workers
- **CDN:** Cloudflare
- **Database:** Neon PostgreSQL
- **Storage:** Cloudflare R2
- **Search:** Meilisearch/ElasticSearch

### DevOps:
- **CI/CD:** GitHub Actions
- **Package Manager:** pnpm + Turborepo
- **Monitoring:** Cloudflare Analytics + Sentry
- **Logging:** Cloudflare Logs → ClickHouse

---

## 12. Ключевые метрики успеха

### Пользовательские метрики:
- **DAU/MAU** — ежедневные/месячные активные пользователи
- **Конверсия в VIP** — % пользователей, оформивших VIP
- **Реферальная эффективность** — среднее число приглашений на пользователя
- **Вовлечённость** — среднее число действий на пользователя

### Технические метрики:
- **Uptime** — соответствие SLO (99.5-99.9%)
- **Latency** — P95/P99 время ответа
- **Error Rate** — < 0.1-0.2% в зависимости от сервиса
- **Build Time** — время сборки модулей

### Бизнес-метрики:
- **Количество RF-партнёров**
- **Использование ваучеров** — конверсия просмотров в использование
- **Прохождение квестов** — количество завершённых квестов
- **Токеномика** — оборот Points/G2A, выпуск NFT

---

## 13. Риски и митигация

### Технические риски:
1. **Сложность микросервисов** → Чёткие контракты через OpenAPI
2. **Производительность агрегации** → Кэширование, Edge-функции
3. **Блокчейн-интеграция** → Изоляция через Gateway, тестирование на testnet

### Бизнес-риски:
1. **Юридические вопросы токенов** → Кастодиальные кошельки, утилитарная модель
2. **Низкая конверсия в VIP** → Оптимизация value proposition
3. **Недостаток партнёров RF** → Активная работа PRO-кураторов

### Операционные риски:
1. **Масштабирование БД** → План миграции на Neon, шардирование
2. **Мониторинг множества сервисов** → Централизованное логирование, алерты
3. **Координация разработки** → Мультиагентная модель, чёткие playbooks

---

## 14. Следующие шаги

После завершения изучения документации команда должна:

1. **Утвердить архитектурные решения** — подтвердить выбор технологий
2. **Детализировать OpenAPI спецификации** — описать все endpoints
3. **Создать Implementation Plan** — разбить на фазы и этапы
4. **Подготовить Task Breakdown** — конкретные задачи для агентов
5. **Настроить инфраструктуру** — монорепо, CI/CD, окружения

---

**Документ подготовлен:** AI Assistant (Composer)  
**Основан на:** ENGINEERING_PLAYBOOK, FRONTEND_PLAYBOOK, go2asia_overview_structured, roadmap, tokenomics, backend_microservice

