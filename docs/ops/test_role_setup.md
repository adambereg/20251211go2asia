# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Go2Asia

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–ø–æ—Å–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≤ Clerk –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ `sessionClaims.role`.

---

## üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### ‚úÖ –£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:
- [x] –†–æ–ª—å `admin` –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é `siberialife2021@gmail.com` –≤ Public metadata
- [x] Customize Session Token –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Clerk Dashboard —Å claim `role: "{{user.public_metadata.role || 'spacer'}}"`

### ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Frontend (Next.js)**
- –ù—É–∂–µ–Ω `.env.local` —Å Clerk –∫–ª—é—á–∞–º–∏
- –ó–∞–ø—É—â–µ–Ω–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ `localhost:3000`

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Backend API (Cloudflare Worker)**
- –†–æ–ª—å —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ JWT —Ç–æ–∫–µ–Ω–µ
- –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –ª—é–±–æ–π backend endpoint

---

## üîß –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Frontend

### –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å Clerk –∫–ª—é—á–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Clerk Dashboard](https://dashboard.clerk.com/)
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "go2asia"
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **API Keys**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ:
   - **Publishable Key** (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `pk_test_...`)
   - **Secret Key** (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `sk_test_...`)

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å `.env.local`

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `capsules/frontend-shell/apps/go2asia-pwa-shell/.env.local`:

```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/
NEXT_PUBLIC_API_URL=https://go2asia-api-gateway-staging.fred89059599296.workers.dev
```

**–í–∞–∂–Ω–æ:** –ó–∞–º–µ–Ω–∏—Ç–µ `pk_test_...` –∏ `sk_test_...` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ Clerk Dashboard.

### –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)

```bash
cd capsules/frontend-shell/apps/go2asia-pwa-shell
pnpm install
```

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

```bash
pnpm dev
```

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:3000`

### –®–∞–≥ 5: –í–æ–π—Ç–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª—å

1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:3000`
2. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º `siberialife2021@gmail.com`
3. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:3000/api/test-role`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "userId": "user_34vD_6k5RwIZ59",
  "role": {
    "fromSessionClaims": "admin",
    "fromPublicMetadata": "admin",
    "match": true
  },
  "message": "‚úÖ –†–æ–ª—å admin —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞ –∏–∑ sessionClaims.role!",
  "sessionClaims": {
    "role": "admin",
    "sub": "user_34vD_6k5RwIZ59",
    ...
  }
}
```

---

## üîß –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Backend API

–ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª—å —á–µ—Ä–µ–∑ backend API.

### –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å JWT —Ç–æ–∫–µ–Ω –∏–∑ Clerk

**–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Clerk Dashboard**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Clerk Dashboard ‚Üí **Users** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –í —Ä–∞–∑–¥–µ–ª–µ **Sessions** –Ω–∞–π–¥–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Session Token (JWT)

**–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ Clerk API**
```bash
curl -X POST https://api.clerk.com/v1/sessions \
  -H "Authorization: Bearer YOUR_CLERK_SECRET_KEY" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "user_34vD_6k5RwIZ59"}'
```

### –®–∞–≥ 2: –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JWT —Ç–æ–∫–µ–Ω

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ [jwt.io](https://jwt.io/) –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:

1. –í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–æ–ª–µ "Encoded"
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ `role` –≤ payload

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "sub": "user_34vD_6k5RwIZ59",
  "role": "admin",
  ...
}
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ Backend Worker

–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π endpoint –≤ Auth Service –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π:

```bash
curl -X GET https://go2asia-auth-service-staging.fred89059599296.workers.dev/health \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

–†–æ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π, –µ—Å–ª–∏:

1. ‚úÖ –í `sessionClaims.role` –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `"admin"` (–¥–ª—è –≤–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
2. ‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `publicMetadata.role`
3. ‚úÖ –†–æ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ JWT —Ç–æ–∫–µ–Ω–µ (–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ jwt.io)
4. ‚úÖ Middleware –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å –¥–ª—è –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤

---

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: `role` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ `sessionClaims`

**–ü—Ä–∏—á–∏–Ω–∞:** Customize Session Token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Clerk Dashboard ‚Üí **Sessions** ‚Üí **Customize session token**
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Claims editor –µ—Å—Ç—å: `{ "role": "{{user.public_metadata.role || 'spacer'}}" }`
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
4. –í—ã–π–¥–∏—Ç–µ –∏ –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ (—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω)

### –ü—Ä–æ–±–ª–µ–º–∞: `role` –µ—Å—Ç—å, –Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ `"spacer"` –≤–º–µ—Å—Ç–æ `"admin"`

**–ü—Ä–∏—á–∏–Ω–∞:** –†–æ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –≤ Public metadata –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Clerk Dashboard ‚Üí **Users** ‚Üí –≤–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí **Public metadata**
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å –ø–æ–ª–µ `role: "admin"`
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
4. –í—ã–π–¥–∏—Ç–µ –∏ –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ

### –ü—Ä–æ–±–ª–µ–º–∞: –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `pnpm install`
2. –°–æ–∑–¥–∞–π—Ç–µ `.env.local` —Å Clerk –∫–ª—é—á–∞–º–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ workspace –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: `pnpm install` –≤ –∫–æ—Ä–Ω–µ –º–æ–Ω–æ—Ä–µ–ø–æ

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –†–æ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ç–æ–∫–µ–Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–æ–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)
- –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
- –í production –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ production Clerk –∫–ª—é—á–∏ (`pk_live_...` –∏ `sk_live_...`)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-12  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-12

