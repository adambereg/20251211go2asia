# Phase 1.1: Atlas Asia — План реализации

**Дата:** 2025-01-14  
**Роль:** Planner  
**Модуль:** Atlas Asia (контентный модуль локаций)

---

## 1. Обзор плана

План разбит на этапы с чёткими зависимостями и порядком выполнения. Каждый этап может быть выполнен как отдельный PR или группа PR.

**Общая оценка:** ~8-10 рабочих дней (MVP)

---

## 2. Этапы реализации

### Этап 1: Базовая инфраструктура API-клиента

**Цель:** Создать единый API-клиент и базовую обработку ошибок.

**Задачи:**

1. **Создать базовый HTTP-клиент** (`lib/api/client.ts`)
   - [ ] Реализовать `apiClient` функцию с таймаутом
   - [ ] Добавить обработку ошибок (NetworkError, TimeoutError, ApiError)
   - [ ] Настроить baseUrl из `NEXT_PUBLIC_API_URL`
   - [ ] Добавить типизацию запросов/ответов

2. **Создать классы ошибок** (`lib/api/errors.ts`)
   - [ ] NetworkError
   - [ ] TimeoutError
   - [ ] ApiError
   - [ ] ValidationError
   - [ ] Утилиты для проверки типов ошибок

3. **Создать общие типы** (`lib/api/types.ts`)
   - [ ] ApiResponse<T>
   - [ ] Общие интерфейсы для метаданных

**Зависимости:** Нет  
**Оценка:** 1 день  
**PR:** `feat: add base API client infrastructure`

---

### Этап 2: Типы и клиент для Atlas

**Цель:** Создать типы DTO и API-методы для Atlas.

**Задачи:**

1. **Создать типы Atlas** (`lib/api/atlas/types.ts`)
   - [ ] Country, City, Place интерфейсы
   - [ ] CountryPageData, CityPageData, PlacePageData
   - [ ] Параметры для фильтрации (GetCountriesParams, GetCitiesParams, GetPlacesParams)

2. **Создать Atlas API клиент** (`lib/api/atlas/client.ts`)
   - [ ] Методы для стран: `getCountries`, `getCountry`
   - [ ] Методы для городов: `getCities`, `getCity`
   - [ ] Методы для мест: `getPlaces`, `getPlace`
   - [ ] Обработка query параметров

**Зависимости:** Этап 1  
**Оценка:** 1 день  
**PR:** `feat: add Atlas API client and types`

---

### Этап 3: React Query Hooks для Atlas

**Цель:** Создать React Query hooks для удобного использования в компонентах.

**Задачи:**

1. **Создать query keys** (`lib/api/atlas/hooks.ts`)
   - [ ] Структура ключей для инвалидации
   - [ ] Фабрики для ключей (countries, cities, places)

2. **Создать hooks**
   - [ ] `useCountries` — список стран
   - [ ] `useCountry` — данные страны
   - [ ] `useCities` — список городов
   - [ ] `useCity` — данные города
   - [ ] `usePlaces` — список мест
   - [ ] `usePlace` — данные места

3. **Настроить staleTime**
   - [ ] Страны: 24h
   - [ ] Города: 6h
   - [ ] Места: 1h

**Зависимости:** Этап 2  
**Оценка:** 0.5 дня  
**PR:** `feat: add React Query hooks for Atlas`

---

### Этап 4: UI компоненты (базовые)

**Цель:** Создать переиспользуемые UI компоненты для Atlas.

**Задачи:**

1. **Создать карточки** (`components/atlas/`)
   - [ ] `CountryCard.tsx` — карточка страны
   - [ ] `CityCard.tsx` — карточка города
   - [ ] `PlaceCard.tsx` — карточка места

2. **Создать списки** (`components/atlas/`)
   - [ ] `CountriesList.tsx` — список стран
   - [ ] `CitiesList.tsx` — список городов
   - [ ] `PlacesList.tsx` — список мест

3. **Создать UI компоненты** (`components/ui/`)
   - [ ] `LoadingSpinner.tsx` — индикатор загрузки
   - [ ] `ErrorMessage.tsx` — сообщение об ошибке
   - [ ] `EmptyState.tsx` — пустое состояние

**Зависимости:** Нет (можно параллельно с Этапом 1-3)  
**Оценка:** 1 день  
**PR:** `feat: add Atlas UI components`

---

### Этап 5: Страницы списков

**Цель:** Реализовать страницы списков для стран, городов и мест.

**Задачи:**

1. **Создать структуру роутинга** (`app/atlas/`)
   - [ ] `app/atlas/layout.tsx` — layout с ErrorBoundary
   - [ ] `app/atlas/page.tsx` — главная страница Atlas

2. **Страница списка стран** (`app/atlas/countries/page.tsx`)
   - [ ] Использовать `useCountries` hook
   - [ ] Отобразить список через `CountriesList`
   - [ ] Добавить loading и error states
   - [ ] Добавить метаданные для SEO

3. **Страница списка городов** (`app/atlas/cities/page.tsx`)
   - [ ] Использовать `useCities` hook
   - [ ] Поддержка фильтрации по стране (query параметр)
   - [ ] Отобразить список через `CitiesList`
   - [ ] Добавить loading и error states

4. **Страница списка мест** (`app/atlas/places/page.tsx`)
   - [ ] Использовать `usePlaces` hook
   - [ ] Поддержка фильтрации (city_id, type, categories, tags)
   - [ ] Отобразить список через `PlacesList`
   - [ ] Добавить loading и error states

**Зависимости:** Этап 3, Этап 4  
**Оценка:** 1.5 дня  
**PR:** `feat: add Atlas list pages`

---

### Этап 6: Детальные страницы

**Цель:** Реализовать страницы детальной информации для страны, города и места.

**Задачи:**

1. **Страница страны** (`app/atlas/countries/[id]/page.tsx`)
   - [ ] Использовать `useCountry` hook
   - [ ] Отобразить hero-секцию
   - [ ] Отобразить контент (overview, history, geography и т.д.)
   - [ ] Отобразить список городов
   - [ ] Добавить навигацию "хлебные крошки"
   - [ ] Добавить метаданные для SEO

2. **Страница города** (`app/atlas/cities/[id]/page.tsx`)
   - [ ] Использовать `useCity` hook
   - [ ] Отобразить hero-секцию
   - [ ] Отобразить контент (overview, districts, lifestyle)
   - [ ] Отобразить featured places
   - [ ] Отобразить other places
   - [ ] Добавить навигацию "хлебные крошки"
   - [ ] Добавить метаданные для SEO

3. **Страница места** (`app/atlas/places/[id]/page.tsx`)
   - [ ] Использовать `usePlace` hook
   - [ ] Отобразить hero-секцию с изображением
   - [ ] Отобразить описание (short_description, description)
   - [ ] Отобразить геолокацию (адрес, координаты)
   - [ ] Отобразить рейтинг (если доступно)
   - [ ] Добавить навигацию "хлебные крошки"
   - [ ] Добавить метаданные для SEO

**Зависимости:** Этап 5  
**Оценка:** 2 дня  
**PR:** `feat: add Atlas detail pages`

---

### Этап 7: Error Boundaries и NotFound

**Цель:** Добавить обработку критических ошибок и 404 страниц.

**Задачи:**

1. **Создать ErrorBoundary** (`components/ErrorBoundary.tsx`)
   - [ ] Классовый компонент с обработкой ошибок
   - [ ] Fallback UI с кнопкой перезагрузки
   - [ ] Логирование ошибок

2. **Интегрировать ErrorBoundary**
   - [ ] Добавить в `app/atlas/layout.tsx`
   - [ ] Добавить в корневой layout (опционально)

3. **Создать NotFound страницу** (`app/atlas/not-found.tsx`)
   - [ ] 404 страница для несуществующих ресурсов
   - [ ] Ссылка на главную страницу Atlas

4. **Обработка ошибок в hooks**
   - [ ] Проверка на 404 в API клиенте
   - [ ] Показ NotFound для несуществующих ресурсов

**Зависимости:** Этап 6  
**Оценка:** 0.5 дня  
**PR:** `feat: add error boundaries and not found pages`

---

### Этап 8: Офлайн-кэширование

**Цель:** Реализовать офлайн-доступ к последним просмотренным страницам.

**Задачи:**

1. **Обновить Service Worker** (`app/sw.js/route.ts`)
   - [ ] Добавить Cache First стратегию для просмотренных страниц
   - [ ] Ограничить количество кэшируемых страниц (5 стран, 10 городов, 20 мест)
   - [ ] Добавить логику обновления кэша в фоне

2. **Создать OfflineNotification** (`components/atlas/OfflineNotification.tsx`)
   - [ ] Компонент для уведомления об офлайне
   - [ ] Автоматическое скрытие при восстановлении соединения

3. **Интегрировать уведомление**
   - [ ] Добавить в `app/atlas/layout.tsx`

**Зависимости:** Этап 6  
**Оценка:** 1 день  
**PR:** `feat: add offline caching for Atlas pages`

---

### Этап 9: Mock данные и заглушка API

**Цель:** Создать mock данные для демонстрации функционала до готовности реального API.

**Задачи:**

1. **Создать API routes** (`app/api/atlas/`)
   - [ ] `app/api/atlas/v1/countries/route.ts` — список стран
   - [ ] `app/api/atlas/v1/countries/[id]/route.ts` — данные страны
   - [ ] `app/api/atlas/v1/cities/route.ts` — список городов
   - [ ] `app/api/atlas/v1/cities/[id]/route.ts` — данные города
   - [ ] `app/api/atlas/v1/places/route.ts` — список мест
   - [ ] `app/api/atlas/v1/places/[id]/route.ts` — данные места

2. **Создать mock данные** (`lib/api/atlas/mocks.ts`)
   - [ ] Mock данные для стран (Вьетнам, Таиланд)
   - [ ] Mock данные для городов (Дананг, Бангкок)
   - [ ] Mock данные для мест (достопримечательности)

3. **Настроить переключение**
   - [ ] Использовать mock данные, если `NEXT_PUBLIC_API_URL` не настроен
   - [ ] Или использовать mock данные через env переменную

**Зависимости:** Этап 2 (можно параллельно)  
**Оценка:** 1 день  
**PR:** `feat: add mock data and API routes for Atlas`

---

### Этап 10: Финализация и документация

**Цель:** Завершить реализацию, проверить все требования и обновить документацию.

**Задачи:**

1. **Проверка требований**
   - [ ] Все user stories реализованы
   - [ ] Все acceptance criteria выполнены
   - [ ] Код соответствует архитектуре

2. **Обновить документацию**
   - [ ] `docs/ops/phase1_checklist.md` — чеклист
   - [ ] `docs/ops/phase1_status.md` — статус выполнения
   - [ ] Обновить README (если необходимо)

3. **Финальное тестирование**
   - [ ] Проверить все страницы
   - [ ] Проверить офлайн-режим
   - [ ] Проверить обработку ошибок

**Зависимости:** Все предыдущие этапы  
**Оценка:** 0.5 дня  
**PR:** `chore: finalize Phase 1.1 Atlas implementation`

---

## 3. Порядок выполнения

### Последовательность этапов:

```
Этап 1 (API клиент) 
  ↓
Этап 2 (Atlas типы и клиент)
  ↓
Этап 3 (React Query hooks)
  ↓
Этап 4 (UI компоненты) ─┐
  ↓                      │
Этап 5 (Списки)          │ (можно параллельно)
  ↓                      │
Этап 6 (Детальные)       │
  ↓                      │
Этап 7 (Error Boundaries)│
  ↓                      │
Этап 8 (Офлайн)          │
  ↓                      │
Этап 9 (Mock данные) ────┘
  ↓
Этап 10 (Финализация)
```

### Параллельная работа:

- **Этап 4** (UI компоненты) можно делать параллельно с Этапами 1-3
- **Этап 9** (Mock данные) можно делать параллельно с Этапами 4-8

---

## 4. Критерии завершения этапов

### Этап считается завершённым, если:

1. ✅ Все задачи этапа выполнены
2. ✅ Код проходит линтинг (`npm run lint`)
3. ✅ TypeScript проверка проходит (`npm run typecheck`)
4. ✅ Код соответствует архитектуре из `docs/architecture/frontend_data_access.md`
5. ✅ Создан PR с описанием изменений

---

## 5. Риски и митигация

### Риск 1: Content API недоступен

**Митигация:**
- Этап 9 (Mock данные) решает эту проблему
- Можно работать полностью на mock данных для MVP

### Риск 2: Сложность офлайн-кэширования

**Митигация:**
- Начать с простой реализации (Cache First для просмотренных страниц)
- Улучшить в следующих итерациях

### Риск 3: Производительность при большом количестве данных

**Митигация:**
- Использовать React Query кэширование
- Добавить пагинацию в будущем (не в MVP)

---

## 6. Метрики успеха

### Функциональные метрики:

- ✅ Все страницы (списки и детальные) работают
- ✅ Офлайн-доступ к последним просмотренным страницам
- ✅ Обработка ошибок работает корректно
- ✅ Loading states отображаются

### Технические метрики:

- ✅ Нет дублирования fetch-логики
- ✅ Все типы TypeScript корректны
- ✅ Нет хардкода URL backend
- ✅ Код находится только в `apps/go2asia-pwa-shell/**`

---

## 7. Связанные документы

- `docs/ops/phase1_atlas_requirements.md` — требования
- `docs/architecture/frontend_data_access.md` — архитектура
- `docs/modules/atlas/api_contracts.md` — контракты API
- `docs/modules/atlas/data_model.md` — модель данных

---

**Дата создания:** 2025-01-14  
**Версия:** 1.0  
**Статус:** ✅ Готово для передачи Frontend Dev




