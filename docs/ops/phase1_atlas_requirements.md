# Phase 1.1: Atlas Asia — Требования (Requirements)

**Дата:** 2025-01-14  
**Роль:** Requirements Analyst  
**Модуль:** Atlas Asia (контентный модуль локаций)

---

## 1. Контекст и цели

### 1.1. Бизнес-контекст

Atlas Asia — энциклопедия мест Юго-Восточной Азии, которая служит:
- **Справочником** для путешественников, планирующих поездку
- **Базой геоданных** для всей экосистемы Go2Asia (Pulse, Quest, Rielt, RF и др.)
- **Офлайн-ресурсом** для доступа к справочной информации без интернета

### 1.2. Технический контекст

- **Фронтенд:** Next.js 15 (App Router) в `apps/go2asia-pwa-shell/`
- **Backend:** Content API (временно эмулируется заглушкой/JSON)
- **Аутентификация:** Clerk (роли через `sessionClaims.role`)
- **PWA:** Service Worker для офлайн-доступа
- **Ограничения:** 
  - `capsules/**` — READ-ONLY
  - Не деплоим на Netlify до завершения Phase 0
  - Работаем локально + через задеплоенный backend (если доступен)

---

## 2. Функциональные требования

### 2.1. Иерархия навигации

**Требование FR-1: Трёхуровневая структура локаций**

Система должна поддерживать иерархию:
- **Страна** → **Город** → **Место**

**Детали:**
- Страны доступны по маршруту `/atlas/countries`
- Города доступны по маршруту `/atlas/cities` и `/atlas/countries/[countryId]/cities`
- Места доступны по маршруту `/atlas/places` и `/atlas/cities/[cityId]/places`
- Каждый уровень имеет страницу списка и страницу деталей

---

### 2.2. Страны (Countries)

**Требование FR-2: Список стран**

**User Story US-1:**
```
Как путешественник,
Я хочу видеть список доступных стран Юго-Восточной Азии,
Чтобы выбрать страну для изучения.
```

**Acceptance Criteria:**
- [ ] Страница `/atlas/countries` отображает список стран
- [ ] Каждая страна отображается в виде карточки с:
  - Названием страны
  - Флагом/иконкой
  - Кратким описанием
  - Количеством городов (если доступно)
  - Hero-изображением (если доступно)
- [ ] Карточки кликабельны и ведут на страницу страны
- [ ] Список поддерживает базовую фильтрацию (по региону, если доступно)
- [ ] При загрузке данных показывается loading state
- [ ] При ошибке загрузки показывается error state

---

**Требование FR-3: Страница страны**

**User Story US-2:**
```
Как путешественник,
Я хочу изучить информацию о стране,
Чтобы понять её особенности, визовый режим и культуру.
```

**Acceptance Criteria:**
- [ ] Страница `/atlas/countries/[countryId]` отображает:
  - Hero-секцию с названием и кратким описанием
  - Основной контент (описание, история, география, культура, визы, бизнес)
  - Список городов в этой стране (ссылки на страницы городов)
  - Популярные места (топ-5, если доступно)
- [ ] Контент загружается через Content API
- [ ] Поддерживается офлайн-доступ к последним просмотренным страницам
- [ ] Навигация "хлебные крошки": Главная → Atlas → Страны → [Название страны]
- [ ] Метаданные для SEO (title, description, og:image)

---

### 2.3. Города (Cities)

**Требование FR-4: Список городов**

**User Story US-3:**
```
Как путешественник,
Я хочу видеть список городов в стране,
Чтобы выбрать город для изучения или планирования поездки.
```

**Acceptance Criteria:**
- [ ] Страница `/atlas/cities` отображает список всех городов
- [ ] Страница `/atlas/countries/[countryId]/cities` отображает города конкретной страны
- [ ] Каждый город отображается в виде карточки с:
  - Названием города
  - Названием страны
  - Кратким описанием
  - Изображением (если доступно)
- [ ] Карточки кликабельны и ведут на страницу города
- [ ] Поддерживается фильтрация по стране (через query параметры)
- [ ] Loading и error states реализованы

---

**Требование FR-5: Страница города**

**User Story US-4:**
```
Как путешественник,
Я хочу изучить информацию о городе,
Чтобы понять его районы, инфраструктуру и лучшие места.
```

**Acceptance Criteria:**
- [ ] Страница `/atlas/cities/[cityId]` отображает:
  - Hero-секцию с названием и кратким описанием
  - Основной контент (обзор, районы, lifestyle)
  - Список популярных мест в городе (featured places)
  - Дополнительные места (other places)
  - Блок "Russian Friendly партнёры" (если доступно)
  - Блок "События" (если доступно, интеграция с Pulse)
  - Блок "Квесты и прогулки" (если доступно, интеграция с Quest)
- [ ] Контент загружается через Content API
- [ ] Поддерживается офлайн-доступ
- [ ] Навигация "хлебные крошки": Главная → Atlas → Города → [Название города]
- [ ] Метаданные для SEO

---

### 2.4. Места (Places)

**Требование FR-6: Список мест**

**User Story US-5:**
```
Как путешественник,
Я хочу видеть список мест в городе,
Чтобы выбрать интересные локации для посещения.
```

**Acceptance Criteria:**
- [ ] Страница `/atlas/places` отображает список всех мест
- [ ] Страница `/atlas/cities/[cityId]/places` отображает места конкретного города
- [ ] Каждое место отображается в виде карточки с:
  - Названием места
  - Типом места (достопримечательность, заведение и т.д.)
  - Городом и страной
  - Рейтингом (если доступно)
  - Количеством отзывов (если доступно)
  - Изображением (если доступно)
- [ ] Поддерживается фильтрация:
  - По типу места
  - По категориям
  - По тегам
  - Только RF-партнёры (`has_rf_only`)
  - Только места с квестами (`has_quests_only`)
  - Только места с событиями (`has_events_only`)
- [ ] Карточки кликабельны и ведут на страницу места
- [ ] Loading и error states реализованы

---

**Требование FR-7: Страница места**

**User Story US-6:**
```
Как путешественник,
Я хочу изучить информацию о конкретном месте,
Чтобы понять его историю, расположение и что рядом.
```

**Acceptance Criteria:**
- [ ] Страница `/atlas/places/[placeId]` отображает:
  - Hero-секцию с названием и изображением
  - Краткое описание
  - Подробное описание (RichContent, Markdown/HTML)
  - Геолокацию (координаты, адрес)
  - Карту (если координаты доступны)
  - Рейтинг и количество отзывов
  - Галерею изображений (если доступно)
  - Блок "Рядом с этим местом":
    - События (Pulse)
    - Квесты (Quest)
    - RF-заведения (если это крупная локация)
    - Жильё (Rielt, если доступно)
  - Топ коротких отзывов (если доступно)
- [ ] Контент загружается через Content API
- [ ] Поддерживается офлайн-доступ
- [ ] Навигация "хлебные крошки": Главная → Atlas → Места → [Название места]
- [ ] Метаданные для SEO

---

### 2.5. API-интеграция

**Требование FR-8: Единый API-клиент**

**User Story US-7:**
```
Как разработчик,
Я хочу использовать единый API-клиент для всех запросов к Content API,
Чтобы избежать дублирования кода и обеспечить единообразную обработку ошибок.
```

**Acceptance Criteria:**
- [ ] Создан модуль `apps/go2asia-pwa-shell/lib/api/` со структурой:
  - `client.ts` — базовый fetch wrapper (baseUrl из env, таймаут, обработка ошибок)
  - `types.ts` — типы DTO для Atlas (Country, City, Place и др.)
  - `atlas.ts` — адаптеры/сервисы для Atlas API
- [ ] Базовый клиент поддерживает:
  - Настройку baseUrl через `NEXT_PUBLIC_API_URL`
  - Таймаут запросов (по умолчанию 10 секунд)
  - Обработку ошибок (network, 4xx, 5xx)
  - Типизированные ответы
- [ ] Atlas API клиент предоставляет методы:
  - `getCountries(params?)` — список стран
  - `getCountry(countryId)` — данные страны
  - `getCities(params?)` — список городов
  - `getCity(cityId)` — данные города
  - `getPlaces(params?)` — список мест
  - `getPlace(placeId)` — данные места
- [ ] Все методы возвращают типизированные Promise с обработкой ошибок
- [ ] URL backend не хардкодятся, только через env переменные

---

### 2.6. Офлайн-кэширование

**Требование FR-9: Офлайн-доступ к контенту**

**User Story US-8:**
```
Как путешественник,
Я хочу иметь доступ к последним просмотренным страницам мест без интернета,
Чтобы изучать информацию в офлайне.
```

**Acceptance Criteria:**
- [ ] Service Worker кэширует последние просмотренные страницы:
  - Страны (последние 5)
  - Города (последние 10)
  - Места (последние 20)
- [ ] При открытии страницы в офлайне:
  - Показывается кэшированная версия (если доступна)
  - Отображается уведомление о режиме офлайн
- [ ] Уведомление об офлайне:
  - Не блокирует интерфейс
  - Понятно информирует пользователя
  - Исчезает при восстановлении соединения
- [ ] Кэш обновляется при восстановлении соединения (background sync)
- [ ] Стратегия кэширования: Cache First для просмотренных страниц, Network First для новых запросов

---

### 2.7. Обработка ошибок и состояний загрузки

**Требование FR-10: UX для состояний загрузки и ошибок**

**User Story US-9:**
```
Как пользователь,
Я хочу видеть понятные индикаторы загрузки и сообщения об ошибках,
Чтобы понимать, что происходит с приложением.
```

**Acceptance Criteria:**
- [ ] Loading states:
  - Skeleton loaders для списков
  - Spinner для детальных страниц
  - Плавные переходы между состояниями
- [ ] Error states:
  - ErrorBoundary для критических ошибок React
  - NotFound (404) для несуществующих ресурсов
  - Network error для проблем с API
  - Понятные сообщения об ошибках на русском языке
  - Кнопка "Попробовать снова" для retry
- [ ] Empty states:
  - Сообщение, когда список пуст
  - Предложение действий (например, "Попробуйте другой фильтр")

---

## 3. Нефункциональные требования

### 3.1. Производительность

**Требование NFR-1:**
- Время загрузки первой страницы списка: < 2 секунд (на 3G)
- Время загрузки детальной страницы: < 1.5 секунд (на 3G)
- Плавная прокрутка (60 FPS)

### 3.2. SEO

**Требование NFR-2:**
- Все публичные страницы имеют метаданные (title, description, og:image)
- Структурированные данные (Schema.org) для мест
- Корректные canonical URLs

### 3.3. Доступность

**Требование NFR-3:**
- Базовая поддержка screen readers
- Семантическая HTML-разметка
- Контрастность текста соответствует WCAG AA

### 3.4. Адаптивность

**Требование NFR-4:**
- Корректное отображение на мобильных устройствах (320px+)
- Корректное отображение на планшетах (768px+)
- Корректное отображение на десктопах (1024px+)

---

## 4. Ограничения и допущения MVP

### 4.1. География

- MVP фокусируется на ограниченном числе стран/городов (например, Вьетнам, Таиланд и ключевые курорты)
- Расширение списка стран и городов производится по мере наполнения

### 4.2. Функционал

- Нет UGC-редактирования текстов описаний
- Отзывы только в формате rating + short_review (через Reactions Service)
- Нет online-чата
- Карты: базовая интеграция (Leaflet или простая статическая карта)

### 4.3. Языки

- MVP: только русский язык
- При расширении аудитории: добавление EN (и далее — локализаций)

### 4.4. Данные

- Данные могут быть частично захардкожены или импортированы из внешнего headless CMS
- Единая точка доступа — через Content API (даже если это заглушка)
- В MVP допускается использование mock данных для демонстрации функционала

---

## 5. Критерии приёмки Phase 1.1

### 5.1. Функциональные критерии

- [ ] Реализована иерархия навигации: Страны → Города → Места
- [ ] Созданы страницы списков и детальные страницы для всех уровней
- [ ] Реализован единый API-клиент с базовой обработкой ошибок
- [ ] Реализовано офлайн-кэширование последних просмотренных страниц
- [ ] Реализованы loading и error states
- [ ] Добавлены ErrorBoundary и NotFound для ключевых маршрутов

### 5.2. Технические критерии

- [ ] Код находится только в `apps/go2asia-pwa-shell/**`
- [ ] Не используются хардкод URL backend (только env)
- [ ] Типизация TypeScript для всех DTO
- [ ] Нет дублирования fetch-логики по страницам
- [ ] Service Worker обновлён для поддержки офлайн-кэша

### 5.3. Документационные критерии

- [ ] Создан документ `docs/ops/phase1_plan.md`
- [ ] Создан документ `docs/ops/phase1_checklist.md`
- [ ] Создан документ `docs/ops/phase1_status.md`
- [ ] Создан документ `docs/architecture/frontend_data_access.md` (кратко про API client, кеш, ошибки)

---

## 6. Зависимости

### 6.1. Внешние зависимости

- **Content API:** Временно эмулируется заглушкой или простым JSON
- **Clerk:** Уже настроен, роли работают через `sessionClaims.role`
- **Service Worker:** Базовый SW уже создан в Phase 0.6, нужно расширить для офлайн-кэша

### 6.2. Внутренние зависимости

- **App Shell:** Уже создан в Phase 0.6
- **React Query:** Уже установлен (`@tanstack/react-query`)
- **Tailwind CSS:** Уже настроен

---

## 7. Риски и митигация

### 7.1. Риск: Content API недоступен

**Митигация:**
- Использовать mock данные для MVP
- Создать заглушку API route в Next.js (`/api/atlas/...`)
- Документировать формат данных для будущей интеграции

### 7.2. Риск: Офлайн-кэш занимает много места

**Митигация:**
- Ограничить количество кэшируемых страниц (5 стран, 10 городов, 20 мест)
- Использовать Cache API с ограничением размера
- Периодически очищать старый кэш

### 7.3. Риск: Производительность при большом количестве мест

**Митигация:**
- Реализовать пагинацию для списков
- Использовать виртуализацию для длинных списков (если необходимо)
- Кэшировать списки на клиенте

---

## 8. Связанные документы

- `docs/modules/atlas/overview.md` — обзор модуля Atlas
- `docs/modules/atlas/data_model.md` — модель данных
- `docs/modules/atlas/api_contracts.md` — контракты API
- `capsules/frontend-shell/docs/ui/atlas_ui.md` — UI-справочник (READ-ONLY)
- `docs/ops/phase0_6_status.md` — статус Phase 0.6
- `docs/ops/phase0_7_status.md` — статус Phase 0.7

---

**Дата создания:** 2025-01-14  
**Версия:** 1.0  
**Статус:** ✅ Готово для передачи Architect




